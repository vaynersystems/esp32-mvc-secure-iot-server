

<script type="text/javascript" src="/JS/C/moment.js"></script>
<script type="text/javascript" src="/JS/C/chart.js"></script>
<script type="text/javascript" src="/JS/C/chart.zoom.js"></script>
<script type="text/javascript" src="/JS/C/chart.stream.js"></script>
<style type="text/css">
    .content{
        display: flex;
        flex-direction: column;
    }
    .row{
        font-size: 12px;
        background-color: #fcf3ff;
    }
    .header{
        font-weight: 600;
    }
    .header, .header-sub{
        display: flex;
        /* flex-grow: 1; */
        border-color: #7d4682;
        color: #323;
        /* border-width: 0 0 1px 0;
        border-style: solid; */
        font-size: 20px;
    }
    .header-memory{
        display: flex;
        flex-grow: 1;
        justify-content: space-between;
    }
    .section{
        /* border: solid 1px #f3cfed;
        border-radius: 5px; */
        padding:0px;
        display: flex;
        flex-direction: column;
        margin: 8px 0px;
    }
    .details{
        display: flex;
        flex-wrap: wrap;
        flex-grow: 1;
        
    }
    .detail,
    .detail-wide{
        margin:10px;
        width: 200px;
        border: solid 6px #c780f7;
        border-width: 1px 2px 1px 6px;
        border-radius: 6px;
        padding: 6px 20px;
        background-color: #fcf3ff;        
    }
    .wide{
        width: 468px;
    }
    .conditional{
        display: var(--available,block);
    }
    .detail>div:nth-child(1){
        font-weight: 600;
        font-size: 16px;
    }
    .detail>div:nth-child(2){
        font-size: 14px;
    }
    /* .SPIFFS, .HEAP, .PSRAM, .SKETCH, .NVS, .STACK{
        margin: 10px;
        padding: 6px 20px;       
        display: flex;
        flex-direction: column;
        display: var(--available);
        border: solid 6px #c780f7;
        border-width: 1px 2px 1px 6px;
        border-radius: 6px;
        width: 200px;
    } */
    .bar {
        height: 4px !important;
        background-color: #f5f5f5;
    }.bar::before {
        content: '';
        display: flex;
        justify-content: end;
        width: calc(var(--percent) * 1%);
        height: 3px !important;
        background: hsl(calc(100 - var(--percent)) 95 50) !important;
        
    }    
</style>
<div class="section">
    <div class="header">Global Variables</div>
    <div class="details">
        <div class="detail">
            <div>Time</div>
            <div>$_TIME</div>
        </div>
        <div class="detail">
            <div>Uptime</div>
            <div id="uptime">$_UPTIME seconds</div>
        </div>
        <div class="detail">
            <div>Client IP</div>
            <div><a href="$_CLIENT_IP">$_CLIENT_IP</a></div>
        </div>        
        <div class="detail">
            <div>Server IP</div>
            <div><a href="$_SERVER_IP">$_SERVER_IP</a></div>
        </div>
        <div class="detail">
            <div>Request Path</div>
            <div>$_REQUEST_URL</div>
        </div>        
    </div>
</div>
<div class="section">
    <div class="header">System Info</div>

    <div class="section">
        <div class="details">
            <div class="detail">
                <div>Chip Cores</div>
                <div>$_CHIP_CORES</div>
            </div>
            <div class="detail">
                <div>Chip Model</div>
                <div>$_CHIP_MODEL</div>
            </div>
            <div class="detail">
                <div>Chip Revision</div>
                <div>$_CHIP_REVISION</div>
            </div>
            <div class="detail">
                <div>CPU Frequency</div>
                <div>$_CPU_FREQUENCY Mhz</div>
            </div>
            <div class="detail">
                <div>Flash Mode</div>
                <div>$_FLASH_MODE</div>
            </div>
            <div class="detail">
                <div>Flash Size</div>
                <div>$_FLASH_SIZE</div>
            </div>
            <div class="detail">
                <div>Flash Speed</div>
                <div>$_FLASH_SPEED</div>
            </div>
            <div class="detail">
                <div>SDK Version</div>
                <div>$_SDK_VERSION</div>
            </div>
            <div class="detail">
                <div>Sketch Size</div>
                <div>$_SKETCH_SIZE</div>
            </div> 
         
        </div>   
    </div>
</div>

<div class="section">
    <div class="header">Partitions</div>

    <div class="section">
        <div class="details">
            
            <div class="detail">
                <div>Boot Partition</div>
                <div>$_PARTITION_BOOT_SPACE</div>
            </div> 
            <div class="detail">
                <div>OTA Partition</div>
                <div>$_PARTITION_1_SPACE</div>
            </div> 
        </div>
    </div>
</div>
<div class="section">
    <div class="header">Memory</div>
    <div class="section">
        <div class="header-sub">Storage</div>    
        <div class="details">
            <div class="detail wide conditional" style="--available: $SPIFFS_MEMORY_AVAILABLE;">
                <div class="header-memory">
                    <div>SPIFFS</div>
                    <div>$SPIFFS_MEMORY_PERCENT_USED%</div>
                </div>
                <div class="bar" style="height:28px; --percent: $SPIFFS_MEMORY_PERCENT_USED;"></div>    
                <div class="row">
                    <div>Used: $SPIFFS_MEMORY_USED</div>
                    <div>Free: $SPIFFS_MEMORY_FREE</div>
                    <div>Total: $SPIFFS_MEMORY_TOTAL</div>
                </div>
            </div>
            <div class="detail wide conditional" style="--available: $PSRAM_MEMORY_AVAILABLE;">
                <div class="header-memory">
                    <div>PSRAM</div>
                    <div>$PSRAM_MEMORY_PERCENT_USED%</div>
                </div>   
                <div class="bar" style="height:28px; --percent: $PSRAM_MEMORY_PERCENT_USED;"></div>
                <div class="row">
                    <div>Used: $PSRAM_MEMORY_USED</div>
                    <div>Free: $PSRAM_MEMORY_FREE</div>
                    <div>Total: $PSRAM_MEMORY_TOTAL</div>
                </div>
            </div>
            <div class="detail wide conditional" style="--available: $SKETCH_MEMORY_AVAILABLE;">
                <div class="header-memory">
                    <div>SKETCH</div>
                    <div>$SKETCH_MEMORY_PERCENT_USED%</div>
                </div>  
                <div class="bar" style="-height:28px; --percent: $SKETCH_MEMORY_PERCENT_USED;"></div>    
                <div class="row">
                    <div>Used: $SKETCH_MEMORY_USED</div>
                    <div>Free: $SKETCH_MEMORY_FREE</div>
                    <div>Total: $SKETCH_MEMORY_TOTAL</div>
                </div>
            </div>
            <div class="detail wide conditional" style="--available: $NVS_MEMORY_AVAILABLE;">
                <div class="header-memory">
                    <div>NVS</div>
                    <div>$NVS_PERCENT_USED%</div>
                </div>  
                <div class="bar" style="-height:28px; --percent: $NVS_PERCENT_USED;"></div>    
                <div class="row">
                    <div>Used: $NVS_USED_ENTRIES</div>
                    <div>Free: $NVS_FREE_ENTRIES</div>
                    <div>Total: $NVS_TOTAL_ENTRIES</div>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="header-sub">RAM</div>    
        <div class="details">
            <div class="detail wide conditional">
                <div class="header-memory">
                    <div>STACK</div>
                    <div>$STACK_PERCENT_USED%</div>
                </div>  
                <div class="bar" style="-height:28px; --percent: $STACK_PERCENT_USED;"></div>    
                <div class="row">
                    <div>Used: $STACK_USED</div>
                    <div>Free: $STACK_FREE</div>
                    <div>Total: $STACK_TOTAL</div>
                </div>
            </div>
            <div class="detail wide conditional" style="--available: $HEAP_MEMORY_AVAILABLE;">
                <div class="header-memory">
                    <div>HEAP</div>
                    <div>$HEAP_MEMORY_PERCENT_USED%</div>
                </div>   
                <div class="bar" style="height:28px; --percent: $HEAP_MEMORY_PERCENT_USED;"></div>
                <div class="row">
                    <div>Used: $HEAP_MEMORY_USED</div>
                    <div>Free: $HEAP_MEMORY_FREE</div>
                    <div>Total: $HEAP_MEMORY_TOTAL</div>
                </div>
            </div>        
        </div>
    </div>
</div>

<div class="section">
    <div class="header">Live Monitor</div>
    <div class="section">
        <div class="header-sub">Web Socket</div>    
        <div class="details">
            <div class="detail wide conditional">
                <div class="row">
                    <div class="header">Status</div>
                    <div id="connection-status"></div>
                </div>  
                
            </div>           
        </div>
    </div>
    <div class="section">
        <div class="header-sub">STACK</div>    
        <div class="details">
            <div class="detail wide conditional">
                <div class="row">
                    <canvas id="stack-chart"></canvas>
                </div>  
                
            </div>           
        </div>

        <div class="header-sub">HEAP</div>    
        <div class="details">
            <div class="detail wide conditional">
                <div class="row">
                    <canvas id="heap-chart"></canvas>
                </div>  
                
            </div>           
        </div>
    </div>
</div>

<script type="text/javascript" src="/JS/esp32_socket.js"></script>
<script type="text/javascript">
    let persistanceSocket = new esp32_socket('status');

    document.addEventListener('DOMContentLoaded', () => {
        
        lastLiveDataFrame = {};
        persistanceSocket.connect(serverMessage);
        setTimeout(updateStatus, 1000);
        console.log(persistanceSocket);

        //initialize charts
        createChart('stack-chart',[
            {
                label: 'Free Stack',
                borderColor: '#F70809',
                backgroundColor: 'rgba(127,124,210, .4)',
                field: 'STACK_FREE',
                fill: false,
            },
            {
                label: 'Used Stack',
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(240,160,70, .3)',
                field: 'STACK_USED',
                fill: false,
            },
            {
                label: 'Total Stack',
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(167, 162, 235, 0.1)',
                field: 'STACK_TOTAL'
            }
        ]);

        createChart('heap-chart',[
            {
                label: 'Free Heap',
                borderColor: '#F70809',
                backgroundColor: 'rgba(127,124,210, .4)',
                field: 'HEAP_FREE',
                cubicInterpolationMode: 'easeInCubic'
            },
            {
                label: 'Used Heap',
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.25)',
                field: 'HEAP_USED',
                cubicInterpolationMode: 'easeInCubic'
            },
            {
                label: 'Total Heap',
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(167, 162, 235, 0.1)',
                field: 'HEAP_TOTAL'
            }
        ]);

        
    }, false);
    
    function serverMessage(event){
        if(event.data === null || event.data === undefined) return;
        if(event.data == 'pong') return; 
        
        //update chart stream data
        lastLiveDataFrame = JSON.parse(event.data);
        //update uptime clock
        setUptime(lastLiveDataFrame.UPTIME);
    }
    
    function setUptime(seconds){
        const uptimeElement = document.getElementById('uptime');
        var timeLeft = seconds;
        if(uptimeElement === null) return;
        
        var partHours=0, partMinutes=0, partSecods = 0;
        if(timeLeft / 3600 > 1){
            partHours = Math.floor(timeLeft / 3600);
            timeLeft -= partHours * 3600;
        }
        if(timeLeft / 60 > 1){
            partMinutes = Math.floor(timeLeft / 60);
            timeLeft -= partMinutes * 60;
        }
        partSeconds = timeLeft;

        uptimeElement.textContent = (partHours > 0 ? partHours + (partHours > 1 ? ' hours ' : ' hour ') : '') +
            (partMinutes > 0 ? partMinutes + (partMinutes > 1 ? ' minutes ' : ' minute ') : '') +
            (partSeconds > 0 ? partSeconds + (partSeconds > 1 ? ' seconds ' : ' second ') : '');
    }

    function updateStatus(){
        const connectionStatusElement = document.getElementById('connection-status');
        if(connectionStatusElement === null) return;
        
        persistanceSocket.send(''); //anything other than ping to this service will return memory usage
        connectionStatusElement.innerHTML = printStateName( persistanceSocket.socket.readyState);

        if(persistanceSocket.socket.readyState == 3)
            persistanceSocket.connect( serverMessage);
        setTimeout(updateStatus, 2500);
    }

    function printStateName(state){
        switch(state){
            case 0:
                return 'Connecting';
                
            case 1:
                return 'Open';
            case 2:
                return 'Closing';
            default:
                return 'Closed';
        }        
    }

    function createChart(chartEmementId, chartDatasets){
        var ctx = document.getElementById(chartEmementId).getContext('2d');
        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: chartDatasets
                
            },
            options: {
              
                scales: {
                    xAxes: [{
                        type: 'realtime',
                        realtime: {
                            delay: 2500,
                            onRefresh: function(chart) {
                                if(persistanceSocket.socket.readyState !== 1) return;
                                chart.data.datasets.forEach(ds => {
                                    ds.data.push({
                                        x: Date.now(),
                                        y: lastLiveDataFrame[ds.field]    
                                    })
                                })       
                            }

                        }
                    }],
                    yAxes: [{
                        ticks:{
                            /* beginAtZero: true, */
                            callback: function(value,index,ticks){
                                if(value/1024/1024 > 1.05)
                                    return Math.round((value/1024/1024) * 100) / 100 + ' MB';
                                if(value/1024 > 1.05)
                                    return Math.round((value/1024) * 100) / 100 + ' KB';
                                return value + ' B';
                            }
                        }
                    }]
                },
                plugins: {
                    zoom:{
                        pan: {
                            enabled: true,
                            mode: 'x',
                            rangeMax: {
                                x: 400
                            },
                            rangeMin: {
                                x: 0
                            }
                        },
                        zoom: {
                            enabled: true,
                            mode: 'x',
                            wheel: {
                                enabled: true
                            },
                            rangeMax: {
                                x: 20000
                            },
                            rangeMin: {
                                x: 1
                            }
                        }
                    }
                }
            }
        });
    }
  </script>
  

